flowchart TD

subgraph TITLE[Azure Serverless Sentiment Analysis Pipeline]
end

%% -------------------------
%% ARCHITECTURE DIAGRAM
%% -------------------------

subgraph ARCHI[Architecture]
direction LR

U[User Upload<br>(Portal / az CLI / SDK)] --> A

subgraph Storage[Azure Blob Storage]
  A[input/ (CSV files)]
  O[output/ (JSON chunks)]
end

A -->|Blob Trigger| F[Azure Function App<br>process_blob()]

F -->|HTTP POST /predict<br>(batches)| C[Container App API<br>FastAPI + Transformers]

C -->|JSON predictions| F

F -->|Write output chunks| O
F -->|Logs & Traces| AI[Application Insights]

AI --> Dash[Dashboards, Logs,<br>Alerts, Metrics]
end

%% -------------------------
%% REPO STRUCTURE
%% -------------------------

subgraph REPO[Repository Structure]
direction TB
R0[.]
R1[├─ api/]
R2[│   ├─ app.py]
R3[│   ├─ inference.py]
R4[│   ├─ Dockerfile]
R5[│   └─ requirements.txt]
R6[├─ function/]
R7[│   ├─ function_app.py]
R8[│   ├─ host.json]
R9[│   ├─ local.settings.json]
R10[│   └─ requirements.txt]
R11[├─ samples/]
R12[│   └─ demo_small.csv]
R13[├─ docs/]
R14[│   └─ architecture.png]
R15[└─ .github/workflows/]
R16[    └─ build-push.yml]
end

%% -------------------------
%% DEPLOYMENT
%% -------------------------

subgraph DEPLOY[Setup Instructions]
direction TB
D1["1. Build & Push Image:
docker buildx build --platform linux/amd64 -t \$ACR_SERVER/mlapi:v1 -f api/Dockerfile .
docker push \$ACR_SERVER/mlapi:v1"]

D2["2. Deploy Container App:
az containerapp create \\
  -g rg-mlserverless-dev -n ca-mlapi-dev \\
  --environment cae-mlserverless-dev \\
  --image \$ACR_SERVER/mlapi:v1 \\
  --ingress external --target-port 8000 \\
  --min-replicas 1 --cpu 1 --memory 2Gi \\
  --registry-server \$ACR_SERVER \\
  --registry-username \$ACR_USER \\
  --registry-password \$ACR_PASS"]

D3["3. Create Blob Containers:
az storage container create --account-name <storage> --name input
az storage container create --account-name <storage> --name output"]

D4["4. Deploy Azure Function:
cd function
func azure functionapp publish func-mlserverless-dev --build remote"]

D5["5. Configure Settings:
az functionapp config appsettings set \\
  -g rg-mlserverless-dev -n func-mlserverless-dev \\
  --settings API_URL='https://ca-mlapi-dev.<id>.francecentral.azurecontainerapps.io/predict' \\
             CHUNK_SIZE=20 TIMEOUT_SEC=180 OUTPUT_CONTAINER=output"]
end

%% -------------------------
%% TESTING
%% -------------------------

subgraph TEST[Testing]
direction TB

T1["Small File:
az storage blob upload \\
  --account-name <storage> \\
  --container-name input \\
  --file samples/demo_small.csv \\
  --name demo_small.csv"]

T2["Expected Output:
demo_small.csv.0000.json
demo_small.csv.manifest.json"]

T3["Large CSV:
az storage blob upload \\
  --account-name <storage> \\
  --container-name input \\
  --file big.csv \\
  --name input.csv"]
end

%% -------------------------
%% MONITORING
%% -------------------------

subgraph MONITOR[Monitoring (Kusto)]
direction TB

M1["View Logs:
traces | where timestamp > ago(2h)"]
M2["API Requests:
requests | where timestamp > ago(2h)"]
M3["Exceptions:
exceptions | where timestamp > ago(2h)"]
end

%% -------------------------
%% ERRORS
%% -------------------------

subgraph ERRORS[Error Handling]
E1["Timeout → increase TIMEOUT_SEC"]
E2["Large batches → reduce CHUNK_SIZE"]
E3["Empty CSV → write minimal JSON"]
E4["API down → write error JSON chunk"]
end

%% -------------------------
%% CLEANUP
%% -------------------------

subgraph CLEANUP[Cleanup]
C1["az group delete -n rg-mlserverless-dev"]
end

